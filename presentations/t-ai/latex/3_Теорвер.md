---
title: "Олимпиадная математика: Теория вероятностей"
author: "Калашников Александр"
institute: "Wildberries & Russ, ФКН ВШЭ"
format:
  beamer:
    pdf-engine: xelatex
    aspectratio: 169
    fontsize: 10pt
    section-titles: true
    incremental: false
    include-in-header: ./xeheader.tex
header-includes:
  - \newcommand{\bgimage}{./logo2.png}
  - \usepackage{tikz}
  - \usetikzlibrary{shapes.geometric, arrows.meta, positioning, calc, decorations.pathreplacing, trees, automata}
  - \usepackage{amsmath, amssymb}
---

# 1. Теоретический арсенал

## Почему школьная вероятность ломается?

В школе нас учат классической формуле:
$$ \mathbb{P} = \frac{\text{Подходящие исходы}}{\text{Все возможные исходы}} $$

**Проблема олимпиад и Computer Science:**

1. Пространство исходов достигает астрономических величин ($10^{100}$).
2. События сложнейшим образом зависят друг от друга (вытащил элемент $\to$ изменил шансы для всех остальных).
3. Процессы могут зацикливаться и длиться бесконечно.

\vspace{0.3cm}

:::: {.columns}
::: {.column width="60%"}
**Наши 6 инструментов взлома на сегодня:**

1. Условная вероятность (Формула Байеса)
2. Линейность и Независимость
3. Метод индикаторов
4. Структурная комбинаторика
5. Рекурренты (Динамическое программирование)
6. Графы состояний (Цепи Маркова)
:::
::: {.column width="40%"}
\begin{center}
\begin{tikzpicture}[scale=0.7, level distance=9mm, sibling distance=9mm, thick,
  every node/.style={circle, draw, fill=red!15, minimum size=4mm, inner sep=0pt, font=\scriptsize}]
  \node {$S$}
    child {node {?}
      child {node {?}}
      child {node {?}}
    }
    child {node {?}
      child {node {?}}
      child {node {$\!\dots$}}
    };
  \draw[red, very thick] (-1.0,-1.5) -- (1.2,0.3);
  \draw[red, very thick] (-1.2,-0.2) -- (1.0,-1.6);
\end{tikzpicture}

\vspace{0.2cm}
{\small Дерево перебора? Нет, спасибо!}
\end{center}
:::
::::

## Инструмент 1: Формула Байеса

Условная вероятность $\mathbb{P}(S \mid A)$ отвечает на вопрос: "Какова вероятность причины $S$, если мы *уже точно знаем*, что произошло следствие $A$?".

\begin{block}{Формула Байеса (Разворот условия)}
$$ \mathbb{P}(S \mid A) = \frac{\mathbb{P}(A \mid S) \cdot \mathbb{P}(S)}{\mathbb{P}(A)} $$
Где полная вероятность в знаменателе собирается из всех возможных сценариев:
$\mathbb{P}(A) = \mathbb{P}(A \mid S)\mathbb{P}(S) + \mathbb{P}(A \mid \overline{S})\mathbb{P}(\overline{S})$.
\end{block}

:::: {.columns}
::: {.column width="50%"}
**Как это работает на пальцах?**
Мы строим дерево вероятностей. Нас интересует отношение "веса нужной нам ветки" ко "всей сумме весов веток, которые привели к наблюдаемому результату".
:::
::: {.column width="50%"}
\begin{center}
\begin{tikzpicture}[thick, >=Stealth, level distance=1.2cm, sibling distance=2.5cm]
  \node {Старт}
    child {node[fill=blue!10, rounded corners] {$S$}
      child {node[fill=green!10, rounded corners] {$A$} edge from parent[->] node[left, font=\footnotesize] {$\mathbb{P}(A|S)$}}
      child {node {$\overline{A}$} edge from parent[->]}
    }
    child {node[fill=blue!10, rounded corners] {$\overline{S}$}
      child {node[fill=green!10, rounded corners] {$A$} edge from parent[->] node[right, font=\footnotesize] {$\mathbb{P}(A|\overline{S})$}}
      child {node {$\overline{A}$} edge from parent[->]}
    };
\end{tikzpicture}

\vspace{0.1cm}
{\small Байес: Доля левого $A$ во всех $A$}
\end{center}
:::
::::

## Инструмент 2: Линейность и Независимость

**Математическое ожидание** $\mathbb{E}[X]$ — это "справедливое среднее" значение случайной величины.

\begin{block}{Фундаментальная теорема (Сложение)}
Для \textbf{любых} случайных величин $X$ и $Y$ выполняется:
$$ \mathbb{E}[X + Y] = \mathbb{E}[X] + \mathbb{E}[Y] $$
\textbf{Важно:} Работает ВСЕГДА. Даже если $X$ и $Y$ катастрофически зависят друг от друга!
\end{block}

:::: {.columns}
::: {.column width="55%"}
**Умножение:**
А вот для произведения зависимость критична. Если $X$ и $Y$ строго **независимы** (результат одной не даёт информации о другой), то:
$$ \mathbb{E}[X \cdot Y] = \mathbb{E}[X] \cdot \mathbb{E}[Y] $$
*(Это свойство спасёт нас в задачах с полиномами).*
:::
::: {.column width="45%"}
\begin{center}
\begin{tikzpicture}[thick, >=Stealth]
  \node[draw, rounded corners, fill=yellow!10, inner sep=8pt, text width=4cm, align=center] {Сумма средних всегда равна среднему суммы!};
\end{tikzpicture}
\end{center}
:::
::::

## Инструмент 3: Метод индикаторов

Как применять линейность на практике? Разбивать сложную задачу на атомарные части.

:::: {.columns}
::: {.column width="50%"}
**Алгоритм:**

1. Разбиваем сложную величину $X$ на сумму простых "выключателей" (индикаторов).
   $I_k = 1$ (событие произошло), $I_k = 0$ (нет).
   $$ X = I_1 + I_2 + \dots + I_n $$
2. Считаем шанс включения одного:
   $$ \mathbb{E}[I_k] = \mathbb{P}(I_k = 1) $$
3. Суммируем! Про зависимости забываем.
:::
::: {.column width="50%"}
\begin{center}
\begin{tikzpicture}[thick]
  \foreach \i/\c in {0/yellow!80, 1/gray!30, 2/yellow!80, 3/yellow!80} {
    \node[circle, draw, fill=\c, minimum size=8mm, font=\small] at (\i*1.1, 0) {$I_{\pgfmathparse{int(\i+1)}\pgfmathresult}$};
  }
  \draw[decorate, decoration={brace, amplitude=5pt, mirror}, thick] (-0.3, -0.7) -- (3.6, -0.7)
    node[midway, below=6pt, font=\small] {$X = \sum I_k$};
\end{tikzpicture}

\vspace{0.5cm}
\end{center}
:::
::::

## Инструмент 4: Структурная комбинаторика

Иногда вероятности опираются на неочевидные комбинаторные структуры. Запомним две главные:

:::: {.columns}
::: {.column width="50%"}
**1. Тождество Вандермонда**
У вас $n$ яблок и $n$ груш. Выбираем ровно $n$ фруктов. Вы можете взять $k$ яблок и $n-k$ груш.
Суммируя по всем $k$, мы получаем просто выбор $n$ элементов из общего числа $2n$:
$$ \sum_{k=0}^{n} C_n^k \cdot C_n^{n-k} = C_{2n}^n $$
*(Учитывая $C_n^{n-k} = C_n^k$, сумма квадратов сочетаний даёт $C_{2n}^n$).*
:::
::: {.column width="50%"}
**2. Беспорядки (Derangements)**
Сколько существует перестановок $n$ элементов, где **ни один** элемент не остался на своём исходном месте?
Формула включений-исключений даёт:
$$ D_n = n! \sum_{k=0}^{n} \frac{(-1)^k}{k!} $$
*(При $n \to \infty$ доля таких перестановок стремится к $e^{-1} \approx 36.8\%$).*
:::
::::

## Инструмент 5: Рекуррентные соотношения (Динамика)

Если нас просят найти вероятность или количество исходов в процессе длины $N$ (игры, генерация строк), перебор работает за $O(2^N)$ и убивает решение. Ответ скрыт в **рекуррентном соотношении**.

:::: {.columns}
::: {.column width="50%"}
**Идея ДП:**
Не пытайтесь посчитать всю строку сразу. Посмотрите на её **последний элемент** и сведите задачу к строке длины $N-1$.

**Пример (Числа Фибоначчи):**
Сколько бинарных строк длины $N$ не содержат "00"?

- Если кончается на 1 $\to$ до неё любая правильная строка длины $N-1$.
- Если кончается на 0 $\to$ перед ним обязана стоять 1 (`..10`), значит впереди строка длины $N-2$.
$$ F_N = F_{N-1} + F_{N-2} $$
:::
::: {.column width="50%"}
\begin{center}
\begin{tikzpicture}[thick]
  \node[draw, fill=blue!10, minimum width=3cm, minimum height=0.6cm] at (0, 1) {$N-1$ элементов};
  \node[draw, fill=green!20, minimum width=0.6cm, minimum height=0.6cm] at (2.1, 1) {1};
  
  \node[draw, fill=blue!10, minimum width=2.4cm, minimum height=0.6cm] at (-0.3, 0) {$N-2$ элементов};
  \node[draw, fill=green!20, minimum width=0.6cm, minimum height=0.6cm] at (1.5, 0) {1};
  \node[draw, fill=red!20, minimum width=0.6cm, minimum height=0.6cm] at (2.1, 0) {0};
  
  \node at (-3, 0.5) {$F_N = $};
\end{tikzpicture}

\vspace{0.5cm}
{\small Комбинаторика сводится к простому сложению!}
\end{center}
:::
::::

## Инструмент 6: Цепи Маркова (Бесконечные процессы)

Если система случайно блуждает по состояниям, и нам нужно узнать **ожидаемое время до финиша**, суммировать ряды по шагам — путь в тупик.

:::: {.columns}
::: {.column width="50%"}
**Метод первых шагов:**

1. Группируем исходы в классы симметрии (макросостояния).
2. Вводим $E_i$ — ожидаемое время *из состояния $i$ до финиша*.
3. Составляем уравнение:
$$E_i = \underbrace{1}_{\text{шаг}} + \sum_j \left( \mathbb{P}_{i \to j} \times E_j \right)$$
:::
::: {.column width="50%"}
\begin{center}
\begin{tikzpicture}[node distance=2.5cm, auto, thick, >=Stealth]
  \node[circle, draw=blue, fill=blue!10, minimum size=1cm] (S2) {$E_{\text{старт}}$};
  \node[circle, draw=orange, fill=orange!10, minimum size=1cm, right of=S2] (S1) {$E_{\text{мид}}$};
  \node[circle, draw=green!60!black, fill=green!10, minimum size=1cm, right of=S1] (S0) {$0$};

  \path[->] (S2) edge[bend left=30] node[above] {$p_1$} (S1);
  \path[->] (S2) edge[loop above] node {$p_2$} (S2);
  \path[->] (S1) edge[bend left=30] node[above] {$p_3$} (S0);
  \path[->] (S1) edge[bend left=30] node[below] {$p_4$} (S2);
\end{tikzpicture}

\vspace{0.3cm}
\end{center}
:::
::::

---

---

# 2. Задача 1: Сырники на завтрак (Разминка)

## Условие задачи

Юра ест сырники на завтрак с вероятностью $1/3$.

- Если он **поел** сырники, то с вероятностью $1/2$ он будет весь день врать, а с $1/2$ — говорить правду.
- Если он **не поел** сырники, то он врёт с вероятностью $2/5$, а говорит правду с вероятностью $3/5$.

Сегодня Юра объявил: **"Я поел сырники!"**
**Вопрос:** Найдите вероятность того, что он действительно их поел.

## Дерево исходов и Формализация

Обозначим события:
$S$ = \{Юра действительно поел сырники\},
$A$ = \{Юра сказал фразу "Я поел сырники"\}.

:::: {.columns}
::: {.column width="50%"}
Нам нужно найти $\mathbb{P}(S \mid A)$.

Когда Юра может произнести фразу "Я поел сырники"?

1. Он **поел** их и говорит **правду**.
2. Он **не ел** их, но **врёт**.

Найдём вероятности этих веток.
:::
::: {.column width="50%"}
\begin{center}
\begin{tikzpicture}[scale=0.8, transform shape, thick, >=Stealth, level 1/.style={sibling distance=4cm, level distance=1.3cm}, level 2/.style={sibling distance=2.2cm, level distance=1.3cm}]
  \node {Завтрак}
    child {node[draw, fill=green!10, rounded corners] {$S$ (1/3)}
      child {node {Правда (1/2)} edge from parent[->] node[left, font=\scriptsize] {Говорит $A$}}
      child {node {Ложь (1/2)} edge from parent[->] node[right, font=\scriptsize] {Говорит $\bar{A}$}}
    }
    child {node[draw, fill=red!10, rounded corners] {$\bar{S}$ (2/3)}
      child {node {Правда (3/5)} edge from parent[->] node[left, font=\scriptsize] {Говорит $\bar{A}$}}
      child {node {Ложь (2/5)} edge from parent[->] node[right, font=\scriptsize] {Говорит $A$}}
    };
\end{tikzpicture}
\end{center}
:::
::::

## Применяем формулу Байеса

По формуле Байеса:
$$ \mathbb{P}(S \mid A) = \frac{\mathbb{P}(A \mid S) \mathbb{P}(S)}{\mathbb{P}(A)} $$

:::: {.columns}
::: {.column width="55%"}
**Шаг 1. Числитель (Совместная вероятность):**
Он поел и сказал об этом:
$\mathbb{P}(A \mid S)\mathbb{P}(S) = \frac{1}{2} \cdot \frac{1}{3} = \mathbf{\frac{1}{6}}$

**Шаг 2. Знаменатель (Полная вероятность):**
Он не ел, но сказал, что поел (соврал):
$\mathbb{P}(A \mid \overline{S})\mathbb{P}(\overline{S}) = \frac{2}{5} \cdot \frac{2}{3} = \mathbf{\frac{4}{15}}$

Общая вероятность того, что он произнесет эту фразу:
$\mathbb{P}(A) = \frac{1}{6} + \frac{4}{15} = \frac{5}{30} + \frac{8}{30} = \mathbf{\frac{13}{30}}$
:::
::: {.column width="45%"}
\vspace{1cm}
**Шаг 3. Итог:**
$$ \mathbb{P}(S \mid A) = \frac{1/6}{13/30} = \frac{1}{6} \cdot \frac{30}{13} = \frac{5}{13} $$

\vspace{0.5cm}
\begin{block}{Ответ}
Вероятность равна $\mathbf{5/13}$ (около $38.5\%$).
\end{block}
:::
::::

---

---

# 3. Задача 2: Сумасшедшая старуха (Симметрия)

## Условие задачи

В самолёте $n$ мест и $n$ пассажиров.
Первая заходит "сумасшедшая старуха" (потеряла билет на Место 1) и садится на **случайное** место.

Каждый следующий пассажир:

- садится на своё место, если оно свободно;
- если занято — выбирает **случайное свободное место**.

**Вопрос:** Какова вероятность того, что последний пассажир (с билетом на место $n$) сядет на своё законное место?

## Поиск инварианта (Следим за процессом)

Если рисовать дерево переходов, оно ветвится до факториала. Нам нужна структура!

:::: {.columns}
::: {.column width="50%"}
**Что происходит в салоне?**
В любой момент в проходе стоит ровно **один** "заблудившийся" пассажир. Он смотрит на свободные места и выбирает одно наугад.

**Когда хаос останавливается?**

1. Кто-то выбирает **Место №1** $\implies$ цикл замкнулся, остальные сядут штатно. Последний спасён.
2. Кто-то выбирает **Место №n** $\implies$ место безвозвратно занято. Последний проиграл.
:::
::: {.column width="50%"}
\begin{center}
\begin{tikzpicture}[scale=0.9, thick, >=Stealth]
  \node[draw, rounded corners, fill=green!10, minimum width=2cm, align=center] (s1) at (0,2) {Место 1\\(Спасение)};
  \node[draw, rounded corners, fill=red!10, minimum width=2cm, align=center] (sn) at (0,-2) {Место n\\(Провал)};
  \node[draw, circle, fill=yellow!10] (pass) at (3,0) {Заяц};
  
  \draw[->, dashed] (pass) -- (s1) node[midway, right=2pt] {?};
  \draw[->, dashed] (pass) -- (sn) node[midway, right=2pt] {?};
  \draw[->, dashed] (pass) -- (4, 1.5) node[right] {Место $k$};
  \draw[->, dashed] (pass) -- (4, -1.5) node[right] {Место $m$};
\end{tikzpicture}
\end{center}
:::
::::

## Абсолютная симметрия

Ни у кого из "заблудившихся" пассажиров НЕТ билета ни на Место №1, ни на Место №n.
*(Никто целенаправленно на них не идёт).*

:::: {.columns}
::: {.column width="55%"}
Мы попали в задачу про симметрию исходов! Для любого пассажира, делающего случайный выбор из свободных кресел, эти два места **абсолютно равноправны и неразличимы**.

Игра гарантированно закончится попаданием в одну из этих двух мишеней. А шансы выбрать любую из них на каждом шаге абсолютно одинаковы.
:::
::: {.column width="45%"}
\begin{center}
\begin{tikzpicture}[thick, >=Stealth]
  \node[draw=green!60!black, fill=green!10, rounded corners=4pt, minimum width=1.8cm, minimum height=1.2cm, align=center, font=\bfseries] (s1) at (-1.5, 0) {Место\\[-2pt] \textnumero~1};
  \node[draw=red!70!black, fill=red!10, rounded corners=4pt, minimum width=1.8cm, minimum height=1.2cm, align=center, font=\bfseries] (sn) at (1.5, 0) {Место\\[-2pt] \textnumero~n};
  \node[circle, draw=gray, fill=yellow!15, minimum size=8mm, font=\Large] (q) at (0, 1.8) {?};
  \draw[->, green!60!black, line width=1.2pt] (q) -- (s1) node[midway, left=2pt, font=\footnotesize] {$\frac{1}{2}$};
  \draw[->, red!70!black, line width=1.2pt] (q) -- (sn) node[midway, right=2pt, font=\footnotesize] {$\frac{1}{2}$};
  \node[font=\Large, gray] at (0, 0) {$=$};
\end{tikzpicture}

\vspace{0.5cm}
\begin{block}{Ответ}
Шансы абсолютно равны. Вероятность $\mathbf{1/2}$ для любого $n \ge 2$.
\end{block}
\end{center}
:::
::::

---

---

# 4. Задача 3: Подбор гиперпараметров (Вандермонд)

## Условие задачи

R&D отдел разрабатывает новую ML-модель. У команды есть:

- $n$ различных архитектур нейронных сетей;
- $n$ различных функций активации.

**План эксперимента:**

1. Выбрать $k$ архитектур из $n$.
2. Выбрать $k$ функций активации из $n$.
3. Обучить модель для **каждой** пары (выбранная архитектура + выбранная активация).

**Вопрос:** Сколькими способами можно провести эксперимент, если просуммировать варианты по всем возможным $k \in [0, n]$? *(Найти формулу и значение для $n=10$)*.

## Анализ шага и тождество Вандермонда

Давайте пока заморозим размер $k$.

:::: {.columns}
::: {.column width="55%"}
Способов выбрать $k$ архитектур: $C_n^k$. Функций: $C_n^k$.
Поскольку мы обучаем каждую с каждой, выбор подмножеств *однозначно* задаёт матрицу экспериментов.
Способов для конкретного $k$: $C_n^k \times C_n^k = (C_n^k)^2$.

Нам нужно просуммировать результаты:
$$ S = \sum_{k=0}^{n} (C_n^k)^2 = \sum_{k=0}^{n} C_n^k \cdot C_n^{n-k} $$

По **тождеству Вандермонда** это эквивалентно выбору ровно $n$ объектов из двух групп по $n$ объектов.
:::
::: {.column width="45%"}
\begin{center}
\textbf{Итоговая формула:}
\vspace{0.3cm}

\Large $ S = C_{2n}^n $ \normalsize

\vspace{1cm}
\textbf{Считаем для $n=10$:}
\vspace{0.3cm}

$ C_{20}^{10} = \frac{20!}{10! \cdot 10!} = 184\,756 $

\vspace{0.5cm}
\begin{block}{Ответ}
$\mathbf{184\,756}$
\end{block}
\end{center}
:::
::::

---

---

# 5. Задача 4: Шляпы на вечеринке (Беспорядки)

## Условие задачи

На вечеринку пришло $n$ человек, и каждый был в своей шляпе.
После вечеринки отключают свет, и гости разбирают шляпы вслепую (образуется абсолютно случайная перестановка).

\vspace{0.5cm}
**Два вопроса:**

1. Какова вероятность того, что **хотя бы один** человек уйдёт в своей шляпе?
2. Сколько **в среднем** человек уйдут в своих шляпах?

\vspace{0.5cm}
> **Вопрос к аудитории:** Как интуиция подсказывает — при увеличении числа гостей ($n \to \infty$) среднее число угадавших растёт или падает?

## Часть 1: Вероятность и Беспорядки

Фраза "хотя бы один" — это 100% сигнал перейти к противоположному событию: **"НИКТО не получил свою шляпу"**.

:::: {.columns}
::: {.column width="55%"}
Мы уже знаем эту структуру из теории — это перестановки без неподвижных точек, **беспорядки** ($D_n$).
$$ D_n = n! \sum_{k=0}^{n} \frac{(-1)^k}{k!} $$

Общее количество исходов равно $n!$.
Вероятность того, что никто не угадал: $\frac{D_n}{n!}$.
:::
::: {.column width="45%"}
\begin{center}
\textbf{Ответ на 1 вопрос:}
\vspace{0.3cm}

$ \mathbb{P}(\text{хотя бы 1}) = 1 - \sum_{k=0}^{n} \frac{(-1)^k}{k!} $

\vspace{0.5cm}
{\small При $n \to \infty$ это стремится к $\approx 1 - 1/e \approx 63.2\%$}
\end{center}
:::
::::

## Часть 2: Ожидание (Триумф Индикаторов)

Теперь ищем $\mathbb{E}[X]$ — среднее число людей в своих шляпах.
События катастрофически зависимы! (Если я взял твою шляпу, ты свою не возьмёшь). Рисовать деревья переходов — безумие.

:::: {.columns}
::: {.column width="50%"}
**Вводим индикаторы:**
$$ I_k = \begin{cases} 1, & \text{гость } k \text{ угадал} \\ 0, & \text{иначе} \end{cases} $$
$$ X = I_1 + I_2 + \dots + I_n $$

Чему равно $\mathbb{E}[I_k]$?
Шляпа $k$-го гостя случайно садится на одну из $n$ голов. Шанс её точного возврата:
$$ \mathbb{E}[I_k] = \mathbb{P}(I_k = 1) = \frac{1}{n} $$
:::
::: {.column width="50%"}
**Магия линейности:**
Нам не важна зависимость индикаторов!

$$ \mathbb{E}[X] = \sum_{k=1}^n \mathbb{E}[I_k] $$
$$ \mathbb{E}[X] = n \cdot \frac{1}{n} = \mathbf{1} $$

\vspace{0.5cm}
\begin{block}{Ответ}
В среднем всегда угадывает \textbf{ровно 1 человек}, независимо от размера вечеринки!
\end{block}
:::
::::

---

---

# 6. Задача 5: Случайный корень (Алгебра + $\mathbb{E}$)

## Условие задачи

Случайные величины $a$ и $b$ **независимы** и равномерно распределены на множестве $\{0, 1, 2, \dots, n\}$.
Рассмотрим квадратное уравнение:
$$ x^2 + ax + b = 0 $$
Его корни $x_1$ и $x_2$. Случайная величина $x$ принимает значение $x_1$ или $x_2$ равновероятно (с шансом $1/2$).

**Вопрос:** Найдите математическое ожидание $\mathbb{E}[x^3]$.

## Решение: Переход к коэффициентам (Виет)

Вместо того чтобы искать корни в лоб (они могут быть комплексными), выразим их через коэффициенты по теореме Виета:
$x_1 + x_2 = -a$, \quad $x_1 x_2 = b$.

:::: {.columns}
::: {.column width="55%"}
Так как $x$ выбирается равновероятно, условное ожидание при фиксированных коэффициентах:
$$ \mathbb{E}[x^3 \mid a, b] = \frac{x_1^3 + x_2^3}{2} $$

Используем алгебраическое тождество:
$$ x_1^3 + x_2^3 = (x_1+x_2)^3 - 3x_1x_2(x_1+x_2) $$
$$ x_1^3 + x_2^3 = (-a)^3 - 3b(-a) = 3ab - a^3 $$

Берём ожидание от всего выражения:
$$ \mathbb{E}[x^3] = \frac{3\mathbb{E}[ab] - \mathbb{E}[a^3]}{2} $$
:::
::: {.column width="45%"}
\begin{center}
\begin{tikzpicture}[thick, >=Stealth]
  \node[draw, rounded corners, fill=red!10, text width=4cm, align=center, inner sep=5pt] {
    \textbf{Ключевой момент:}\\
    \vspace{0.2cm}
    Так как $a$ и $b$ \textbf{независимы}:\\
    $\mathbb{E}[ab] = \mathbb{E}[a] \cdot \mathbb{E}[b]$
  };
\end{tikzpicture}

\vspace{0.3cm}
\end{center}
:::
::::

## Подсчет моментов распределения

Нам нужно посчитать $\mathbb{E}[a]$ и $\mathbb{E}[a^3]$ для равномерного распределения на $\{0, \dots, n\}$. Таких чисел ровно $n+1$.

:::: {.columns}
::: {.column width="50%"}
**Сумма арифметической прогрессии:**
$$ \mathbb{E}[a] = \mathbb{E}[b] = \frac{1}{n+1} \sum_{k=0}^n k $$
$$ = \frac{1}{n+1} \frac{n(n+1)}{2} = \frac{n}{2} $$

Значит $\mathbb{E}[ab] = \frac{n}{2} \cdot \frac{n}{2} = \frac{n^2}{4}$.
:::
::: {.column width="50%"}
**Формула суммы кубов:**
$\sum_{k=0}^n k^3 = \left(\frac{n(n+1)}{2}\right)^2$, значит
$\mathbb{E}[a^3] = \frac{n^2(n+1)}{4}$.

Подставляем:
$\mathbb{E}[x^3] = \frac{1}{2}\left(\frac{3n^2}{4} - \frac{n^2(n+1)}{4}\right) = \frac{n^2}{8}(3 - n - 1)$

\begin{block}{Ответ}
$\mathbb{E}[x^3] = \mathbf{\frac{n^2(2-n)}{8}}$
\end{block}
:::
::::

---

---

# 7. Задача 6: Сломанный RecSys (Асимптотика)

## Условие задачи

В систему последовательно поступают $n$ видеороликов, все значения их релевантности $q$ уникальны. Порядок — случайная перестановка.

**Баг системы:** Кандидат показывается пользователю, **только если** его релевантность строго больше, чем у **всех** предыдущих кандидатов.

Пусть $V$ — число показанных роликов.

1. Найдите $\mathbb{E}[V]$.
2. Оцените порядок $n$, при котором $\mathbb{E}[V] > 20$.

## Моделирование показов и Гармонический ряд

Снова индикаторы! $I_k = 1$, если $k$-й поданный ролик был показан.
$$ V = I_1 + I_2 + \dots + I_n $$

:::: {.columns}
::: {.column width="55%"}
**Когда покажут $k$-й ролик?**
Только если он — **самый лучший** среди первых $k$ роликов.
Поскольку порядок абсолютно случаен, "чемпион" на префиксе длины $k$ с равной вероятностью стоит на любой из $k$ позиций. Значит:
$$ \mathbb{E}[I_k] = \frac{1}{k} $$

Суммируем и получаем гармонический ряд:
$$ \mathbb{E}[V] = 1 + \frac{1}{2} + \frac{1}{3} + \dots + \frac{1}{n} = H_n $$
:::
::: {.column width="45%"}
\begin{center}
\begin{tikzpicture}[xscale=0.8, yscale=0.8]
  \draw[thick, ->] (0,0) -- (5.5,0) node[right] {Время};
  \draw[thick, ->] (0,0) -- (0,3) node[above] {$q$};
  
  \filldraw[black] (0.5, 0.8) circle (2pt);
  \filldraw[black] (1.5, 1.5) circle (2pt);
  \filldraw[red] (3.5, 2.5) circle (3pt) node[above right] {$q_k$};
  \draw[dashed, blue] (3.5, 0) -- (3.5, 2.5);
  \draw[decorate, decoration={brace, amplitude=5pt, mirror}, thick] (0.2, -0.5) -- (3.8, -0.5) node[midway, below=5pt] {Префикс $k$};
\end{tikzpicture}
\end{center}
:::
::::

## Оценка Гармонического ряда (Трюк Коши)

Нам нужно найти $n$, при котором $H_n > 20$. Оценим сумму **сверху** блоками по степеням двойки:

:::: {.columns}
::: {.column width="50%"}
$$ H_n = 1 + \frac{1}{2} + \left(\frac{1}{3} + \frac{1}{4}\right) + \left(\frac{1}{5} + \dots + \frac{1}{8}\right) + \dots $$
$\frac{1}{3} + \frac{1}{4} < \frac{1}{2} + \frac{1}{2} = 1$
$\frac{1}{5} + \dots + \frac{1}{8} < 4 \cdot \frac{1}{4} = 1$

Каждый блок из $2^{m-1}$ элементов даёт в сумме строго меньше $1$.
$$ H_{2^m} < 1 + m $$
:::
::: {.column width="50%"}
Если мы хотим, чтобы $\mathbb{E}[V] > 20$, то **необходимо**:
$$ 1+m > H_{2^m} > 20 \implies m \ge 20 $$
Значит, $n$ должно быть как минимум порядка $2^{20}$.

\begin{block}{Внимание, ловушка асимптотики!}
Точная формула: $H_{2^{20}} \approx \ln(2^{20}) + \gamma \approx 14.4$.
Чтобы юзер увидел 20 роликов, нужно $n \approx e^{19.4} \approx \mathbf{2.7 \cdot 10^8}$! Оценка $2^{20}$ — лишь необходимое условие.
\end{block}
:::
::::

---

---

# 8. Задача 7: Пайплайны в продакшене (Графы)

## Условие задачи

Есть пайплайн из 6 независимых блоков. У каждого есть интерфейсы `IN` и `OUT`.

Баг конфигуратора:

- Все 6 выходов (`OUT`) случайно разбились на 3 пары.
- Независимо от этого, 6 входов (`IN`) тоже разбились на 3 пары.

**Вопрос:** Какова вероятность того, что все 6 блоков образуют ровно **одну замкнутую цепочку** длины 6?

## Графовая модель (Замораживаем OUT)

Разбить 6 элементов на 3 пары (совершенное паросочетание) можно $5!! = 5 \cdot 3 \cdot 1 = \mathbf{15}$ способами. Столько же вариантов и для `IN`.

:::: {.columns}
::: {.column width="50%"}
**Шаг 1:** Зафиксируем любое разбиение `OUT`. Эти связи жёстко сшили 6 блоков в 3 пары (Мета-блоки $A, B, C$).
У каждого мета-блока наружу торчат ровно по **2 свободных порта `IN`**.

**Шаг 2:** Чтобы получился единый мега-цикл, 3 связи `IN` должны соединить $A, B, C$ в треугольник ($A \to B \to C \to A$).
:::
::: {.column width="50%"}
\begin{center}
\begin{tikzpicture}[thick, >=Stealth]
  \node[circle, draw=red!70!black, fill=red!10, minimum size=1.1cm, font=\bfseries] (A) at (0, 1.6) {A};
  \node[circle, draw=red!70!black, fill=red!10, minimum size=1.1cm, font=\bfseries] (B) at (2.2, 1.6) {B};
  \node[circle, draw=red!70!black, fill=red!10, minimum size=1.1cm, font=\bfseries] (C) at (1.1, 0) {C};

  \draw[->, blue, very thick] (A) -- node[above, font=\footnotesize] {$4$} (B);
  \draw[->, blue, very thick] (B) -- node[right, font=\footnotesize] {$2$} (C);
  \draw[->, blue, very thick] (C) -- node[left, font=\footnotesize] {$1$} (A);
\end{tikzpicture}
\end{center}
:::
::::

Считаем благоприятные варианты `IN`:

1. Связь A и B: У $A$ 2 порта, у $B$ 2 порта $\implies 2 \times 2 = \mathbf{4}$ способа.
2. Связь B и C: У $B$ остался 1 порт, у $C$ есть 2 порта $\implies 1 \times 2 = \mathbf{2}$ способа.
3. Связь C и A: У обоих по 1 порту $\implies \mathbf{1}$ способ.

\begin{block}{Ответ}
Вероятность равна $\mathbf{\frac{4 \times 2 \times 1}{15} = \frac{8}{15}}$.
\end{block}

---

---

# 9. Задача 8: Кто быстрее (Рекурренты на строках)

## Условие задачи

Катя и Чанбин решают 9 задач на LeetCode. В каждом раунде один победитель (шансы 1/2). Все раунды независимы.
Участник доволен, если у него **не было 3 проигрышей подряд**.
Известно, что **Катя осталась довольна**.

**Вопрос:** Найдите вероятность того, что и Чанбин остался доволен.

*(Сложность: Сложная. Динамическое программирование).*

## Перевод в бинарные строки

Закодируем исходы: `1` = Катя выиграла, `0` = Катя проиграла.

- "Катя довольна" = в строке нет трёх нулей подряд (`000`).
- "Чанбин доволен" = у него нет трёх проигрышей подряд. Но проигрыш Чанбина — это `1` для Кати. Значит, нет `111`.

:::: {.columns}
::: {.column width="55%"}
Нас просят найти условную вероятность:
$$ \mathbb{P}(\text{Нет } 111 \mid \text{Нет } 000) = \frac{N_9}{M_9} $$
Где:

- $M_n$ — число бинарных строк длины $n$ без `000`.
- $N_n$ — число строк длины $n$ без `000` и без `111`.
:::
::: {.column width="45%"}
\begin{center}
\begin{tikzpicture}[thick]
  \node[draw, fill=blue!10, rounded corners, minimum width=3.5cm, minimum height=2cm] (M) at (0, 0) {};
  \node[anchor=north west, font=\footnotesize] at (M.north west) {$M_9$: Без 000};
  \node[draw, fill=green!10, rounded corners, minimum width=2.2cm, minimum height=0.8cm] (N) at (0, -0.15) {\small $N_9$: Без 111};
  \node at (0, -1.5) {\small $N_9 \subset M_9$};
\end{tikzpicture}

\vspace{0.2cm}
\end{center}
:::
::::

## Составление ДП-рекуррент

:::: {.columns}
::: {.column width="50%"}
**1. Считаем $M_n$ (нет 000):**
Правильная строка заканчивается одним из трёх валидных суффиксов:

- `...1` $\to$ до неё любая из $M_{n-1}$
- `...10` $\to$ до неё любая из $M_{n-2}$
- `...100` $\to$ до неё любая из $M_{n-3}$
$$ M_n = M_{n-1} + M_{n-2} + M_{n-3} $$
База: $M_0=1, M_1=2, M_2=4$.
Считаем до 9-го (Трибоначчи):
$7, 13, 24, 44, 81, 149 \implies \mathbf{M_9 = 274}$.
:::
::: {.column width="50%"}
**2. Считаем $N_n$ (нет 000 и 111):**
Строка может состоять только из блоков 똑каковых символов длины 1 или 2. Значит, мы дописываем в конец либо блок из 1 символа, либо из 2 (сменив цвет):
$$ N_n = N_{n-1} + N_{n-2} $$
Это числа Фибоначчи!
База: $N_1=2, N_2=4$.
Считаем до 9-го:
$6, 10, 16, 26, 42, 68 \implies \mathbf{N_9 = 110}$.

\begin{block}{Ответ}
$$ \mathbb{P} = \frac{110}{274} = \mathbf{\frac{55}{137}} $$
\end{block}
:::
::::

---

---

# 10. Задача 9: Три мухи (Цепи Маркова)

## Условие задачи

Три мухи одновременно садятся на правильный пятиугольник — в 3 **различные** вершины.
Каждую минуту *каждая* муха перелетает в одну из 4 других вершин (выбирает случайно и независимо). В одной вершине может сидеть несколько мух.

**Вопрос:** Найдите ожидаемое время $\mathbb{E}[T]$, когда **все три мухи окажутся в одной вершине**.

*(Геометрия пятиугольника не важна, вершины симметричны. Будем переходить к макросостояниям!)*

## Пространство макросостояний

Всего переходов за один шаг для 3 мух: $4^3 = 64$.
Сгруппируем их в 3 макросостояния (классы эквивалентности):

:::: {.columns}
::: {.column width="45%"}

- **S3 (Старт):** Все 3 мухи в разных вершинах. Ожидание времени $\to E_3$.
- **S2:** Две мухи в одной вершине, одна отдельно. Ожидание $\to E_2$.
- **S1 (Финиш):** Все три вместе. $E_1 = 0$.
:::
::: {.column width="55%"}
\begin{center}
\begin{tikzpicture}[node distance=2.5cm, auto, thick, >=Stealth]
  \node[circle, draw=blue, fill=blue!10, minimum size=1cm, align=center] (S3) {S3};
  \node[circle, draw=orange, fill=orange!10, minimum size=1cm, right of=S3, xshift=0.5cm, align=center] (S2) {S2};
  \node[circle, draw=green!60!black, fill=green!10, minimum size=1cm, right of=S2, xshift=0.5cm, align=center] (S1) {S1};

  \path[->] (S3) edge[bend left] node[above] {$p_{32}$} (S2);
  \path[->] (S3) edge[loop above] node {$p_{33}$} (S3);
  \path[->] (S3) edge[bend right=40] node[below] {$p_{31}$} (S1);
  
  \path[->] (S2) edge[bend left] node[below] {$p_{23}$} (S3);
  \path[->] (S2) edge[loop above] node {$p_{22}$} (S2);
  \path[->] (S2) edge[bend left] node[above] {$p_{21}$} (S1);
\end{tikzpicture}
\end{center}
:::
::::

## Матрица переходов: Из S3

Куда мухи (изначально сидящие в A, B, C) прыгают из начального состояния?

:::: {.columns}
::: {.column width="60%"}

1. **В S1 (все вместе):**
   Могут прыгнуть только в пустые D или E. По 1 способу на муху.
   $\implies \mathbf{2}$ исхода.
2. **В S3 (все врозь):**
   Это инъекции без неподвижных точек. Формула включений-исключений даёт $\mathbf{32}$ исхода.
3. **В S2 (две вместе):**
   Оставшиеся исходы: $64 - 2 - 32 = \mathbf{30}$ исходов.
:::
::: {.column width="40%"}
\begin{block}{Метод первых шагов:}
\vspace{0.2cm}
$$E_3 = 1 + \frac{32}{64}E_3 + \frac{30}{64}E_2$$
\end{block}
:::
::::

## Переходы из S2 и Решение системы

Куда мухи (две в A, одна в B) прыгают из S2?

:::: {.columns}
::: {.column width="50%"}

1. **В S1 (все вместе):** Запрещены A и B. Свободны C, D, E. $\implies \mathbf{3}$ исхода.
2. **В S3 (все врозь):** Аналогичная комбинаторика $\implies \mathbf{30}$ исходов.
3. **В S2 (две вместе):** Остаток: $64 - 3 - 30 = \mathbf{31}$ исход.

**Уравнение 2:**
$$E_2 = 1 + \frac{30}{64}E_3 + \frac{31}{64}E_2$$
:::
::: {.column width="50%"}
\begin{center}
\textbf{Решаем систему СЛАУ:}
\end{center}

$64E_3 = 64 + 32E_3 + 30E_2$
$\implies 16E_3 - 15E_2 = 32$

$64E_2 = 64 + 30E_3 + 31E_2$
$\implies -30E_3 + 33E_2 = 64$

\vspace{0.5cm}
Из решения:
$26E_3 = 672 \implies E_3 = \frac{336}{13}$

\begin{block}{Ответ}
$\mathbb{E}[T] = \mathbf{\frac{336}{13}} \approx 25.85$ минут.
\end{block}
:::
::::

---

---

# 11. Задача 10: Два жука (Матожидание на графах)

## Условие задачи

Из полного графа на 5 вершинах ($A, B, C, D, E$) удалили ребро $AB$.
Два жука начинают движение из вершин $A$ и $B$. Каждый ход жук равновероятно переходит в соседнюю вершину, **где он ещё не был**. Движение заканчивается, когда нет ходов. Жуки независимы.

**Вопрос:** Найдите математическое ожидание количества рёбер, по которым прошли **оба** жука.

*(Сложность: Очень сложная. Линейность на индикаторах рёбер).*

## Гамильтоновы пути и Индикаторы

Жук остановится, только пройдя по всем вершинам (поскольку степени вершин равны 4 и 3), то есть сформирует Гамильтонов путь.
Введём индикатор для каждого ребра $e$: $I_e = 1$, если оба прошли по $e$.
$$ X = \sum_e I_e \implies \mathbb{E}[X] = \sum_e \mathbb{P}(\text{оба на } e) $$
Так как жуки независимы: $\mathbb{P}(\text{оба на } e) = p_A(e) \cdot p_B(e)$.

:::: {.columns}
::: {.column width="50%"}
Сколько всего путей из $A$?
Жук перебирает перестановки $B, C, D, E$. Но первый шаг не может быть в $B$ (нет ребра $AB$).
Всего $4! = 24$ перестановки, $B$ на первом месте в $3! = 6$ из них.
Итого **18 равновероятных путей**. Для B всё аналогично.
:::
::: {.column width="50%"}
\begin{center}
\begin{tikzpicture}[scale=1.1, thick]
  \node[circle, draw=blue!80, fill=blue!10, font=\bfseries] (A) at (90:1.3) {A};
  \node[circle, draw=red!80, fill=red!10, font=\bfseries] (B) at (162:1.3) {B};
  \node[circle, draw] (C) at (234:1.3) {C};
  \node[circle, draw] (D) at (306:1.3) {D};
  \node[circle, draw] (E) at (18:1.3) {E};
  \draw (A)--(C) (A)--(D) (A)--(E);
  \draw (B)--(C) (B)--(D) (B)--(E);
  \draw (C)--(D) (D)--(E) (E)--(C);
  \draw[dashed, red, line width=1.5pt] (A) -- (B) node[midway, sloped, above, font=\scriptsize] {Нет ребра};
\end{tikzpicture}
\end{center}
:::
::::

## Подсчет вероятностей для ребер

Разделим 9 рёбер на 3 класса (по симметрии).

:::: {.columns}
::: {.column width="50%"}
**Класс 1: Рёбра из A ($AC, AD, AE$)**
Жук из A пройдет по $AC$, только если пойдет туда на 1-м ходу. $\implies p_A = 1/3$.
Для жука из B: вершины $A$ и $C$ должны стоять рядом в пути. Перебирая 18 путей, находим 10 подходящих. $\implies p_B = 10/18 = 5/9$.
Вклад 3 рёбер: $3 \times (1/3 \times 5/9) = \mathbf{5/9}$.

**Класс 2: Рёбра из B ($BC, BD, BE$)**
По полной симметрии вклад тоже $\mathbf{5/9}$.
:::
::: {.column width="50%"}
**Класс 3: Внутренние рёбра ($CD, CE, DE$)**
Жук из A проходит по $CD$, если они стоят рядом в пути (среди $B,C,D,E$).
Считаем блоки $(CD)$ и $(DC)$:

- Позиции 1-2: 4 пути
- Позиции 2-3: 2 пути
- Позиции 3-4: 2 пути
Итого 8 путей из 18. $\implies p_A = 4/9$.
По симметрии $p_B = 4/9$.
Вклад 3 рёбер: $3 \times (4/9 \times 4/9) = \mathbf{16/27}$.

\vspace{0.3cm}
\begin{block}{Ответ}
$$ \mathbb{E}[X] = \frac{15}{27} + \frac{15}{27} + \frac{16}{27} = \mathbf{\frac{46}{27}} $$
\end{block}
:::
::::

---

---

# 12. Задача 11: Треугольный KNN (Геометрия + ДП)

## Условие задачи

На оси X лежат точки $E_k = (2k, 0)$. Выше оси лежат $U_k = (2k+1, 1)$, ниже $D_k = (2k+1, -1)$.
Каждой точке присвоен класс 1 или 2. Обучен $k$-NN с $k=3$.
Мы предсказываем классы $f$ для тестовых точек $T$: $(2k+0.5, 0)$ и $(2k+1.5, 0)$ для $k \in [0, 7]$.

**Вопрос:** Сколько различных функций предсказания $f: T \to \{1, 2\}$ можно получить при всевозможных разметках обучающей выборки ($n=8$)?

*(Сложность: Хардкор. Сведение KNN к автоматам).*

## Геометрический анализ 1D: Кто соседи?

Давайте посмотрим на тестовые точки вокруг индекса $k$: $T_1 = 2k+0.5$ и $T_2 = 2k+1.5$. Кто их 3 ближайших соседа по евклидову расстоянию?

:::: {.columns}
::: {.column width="55%"}

- Для $T_1$: Ближайшие — это $E_k$ (расстояние 0.5), и точки $U_k, D_k$ (расстояние $\sqrt{0.5^2 + 1^2} \approx 1.11$).
- Для $T_2$: Ближайшие $E_{k+1}, U_k, D_k$.

**Суть голосования:** Точки $U_k$ и $D_k$ голосуют *сразу за обе* тестовые точки! А $E_k$ и $E_{k+1}$ — по отдельности.
:::
::: {.column width="45%"}
\begin{center}
\begin{tikzpicture}[scale=0.9, thick]
  \draw[->] (-0.5, 0) -- (4.5, 0) node[right] {$x$};
  \filldraw[blue] (0,0) circle (2pt) node[below] {$E_k$};
  \filldraw[blue] (4,0) circle (2pt) node[below] {$E_{k+1}$};
  \filldraw[red] (2,1.2) circle (2pt) node[above] {$U_k$};
  \filldraw[red] (2,-1.2) circle (2pt) node[below] {$D_k$};
  \filldraw[green!60!black] (1,0) circle (3pt) node[above left] {$T_1$};
  \filldraw[green!60!black] (3,0) circle (3pt) node[above right] {$T_2$};
  
  \draw[dashed, gray] (1,0) -- (2,1.2);
  \draw[dashed, gray] (1,0) -- (2,-1.2);
  \draw[dashed, gray] (3,0) -- (2,1.2);
  \draw[dashed, gray] (3,0) -- (2,-1.2);
\end{tikzpicture}

\vspace{0.2cm}
\end{center}
:::
::::

## Переход к последовательностям блоков (ДП)

Пара предсказаний $B_k = (f(T_1), f(T_2))$ может принимать 4 значения: $11, 12, 21, 22$.

- Если $U_k, D_k$ одного класса, они забирают 2 голоса из 3. Обе точки получают этот класс ($B_k$ = $11$ или $22$).
- Если $U_k, D_k$ разных классов (ничья), всё решают $E_k$ и $E_{k+1}$. Блок $B_k$ может быть **любым**.

:::: {.columns}
::: {.column width="55%"}
**Запрещенные переходы:**
Если $B_k = 12$, значит $E_{k+1}$ обязан иметь класс 2.
Но если следующий блок $B_{k+1} = 12$, то $E_{k+1}$ обязан иметь класс 1. Противоречие!
**Запрещены стыки:** $12 \to 12$ и $21 \to 21$.

Пусть $C_n$ — число цепочек, оканчивающихся на константу ($11, 22$).
Пусть $V_n$ — на смешанный ($12, 21$).
:::
::: {.column width="45%"}
**Система ДП:**
После $C_n$ можно ставить что угодно. После $V_n$ — ограничение (только 1 вариант из двух смешанных).
$$ C_{n+1} = 2(C_n + V_n) $$
$$ V_{n+1} = 2C_n + 1 \cdot V_n $$

Решая до $n=8$ (стартуя с $C_1=2, V_1=2$), получаем $C_8 = 16084, V_8 = 12558$.

\begin{block}{Ответ}
$A_8 = C_8 + V_8 = \mathbf{28\,642}$
\end{block}
:::
::::

---

---

# 13. Итоги занятия

## Чек-лист: Как взламывать вероятностные олимпиады

:::: {.columns}
::: {.column width="60%"}

1. **Байес спасает от путаницы.** Рисуйте дерево исходов, чтобы найти нужную долю вероятности среди всех возможных сценариев.
2. **Линейность работает всегда.** Разбивайте сложную случайную величину на $1/0$ индикаторы (даже на графах!) и суммируйте вероятности, смело игнорируя их зависимость.
3. **Стройте автоматы и динамику.** Задачи на подсчет правильных последовательностей решаются рекурсиями (сведение $N$ к $N-1$).
4. **Процессы = Марковские цепи.** Бесконечные блуждания (жуки, мухи) сворачивайте в СЛАУ: *Ожидание = 1 шаг + взвешенное ожидание будущего*.
:::
::: {.column width="40%"}
\vspace{1cm}
\begin{tikzpicture}
  \node[draw, fill=blue!10, text width=5cm, rounded corners, inner sep=10pt] {
    \textbf{Главная мысль:}\\
    Сложные вероятностные пространства почти всегда сворачиваются алгеброй или графами. Ищите этот переход!
  };
\end{tikzpicture}
:::
::::
