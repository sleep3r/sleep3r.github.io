<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>sleep3r</title>
<meta name="theme-color" content="#272822">
<style>
 :root{--bg:#272822; --bg2:#3e3d32; --ink:#f8f8f2; --muted:#75715e; --a1:#66d9ef; --a2:#ae81ff; --a3:#a6e22e; --a4:#f92672; --glass:rgba(62,61,50,0.8); --edge:#49483e}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:-apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;line-height:1.5}
body{overflow:hidden}
a{color:inherit;text-decoration:none}
.stage{position:fixed;inset:0;display:block;overflow:hidden}
.noise{display:none}
@keyframes drift{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(10%,10%,0)}}
@keyframes flicker{0%{opacity:0.8}100%{opacity:0.6}}
@keyframes colorShift{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)}}
.orb{display:none}
.o1{width:44vmax;height:44vmax;background:radial-gradient(closest-side, var(--a1), transparent 70%);left:-10vmax;top:-8vmax;animation: float1 12s ease-in-out infinite alternate, pulse1 8s ease-in-out infinite}
.o2{width:36vmax;height:36vmax;background:radial-gradient(closest-side, var(--a2), transparent 70%);right:-8vmax;bottom:-10vmax;animation: float2 15s ease-in-out infinite alternate, pulse2 6s ease-in-out infinite}
.o3{width:28vmax;height:28vmax;background:radial-gradient(closest-side, var(--a3), transparent 70%);left:50%;top:60%;transform:translate(-50%,-50%);animation: float3 20s ease-in-out infinite alternate, pulse3 10s ease-in-out infinite}
.o4{width:32vmax;height:32vmax;background:radial-gradient(closest-side, var(--a4), transparent 70%);left:20%;top:-12vmax;animation: float4 16s ease-in-out infinite alternate, pulse4 7s ease-in-out infinite}
.o5{width:40vmax;height:40vmax;background:radial-gradient(closest-side, var(--a1), transparent 70%);right:15%;top:80%;animation: float5 22s ease-in-out infinite alternate, pulse5 9s ease-in-out infinite}
.o6{width:35vmax;height:35vmax;background:radial-gradient(closest-side, var(--a3), transparent 70%);left:-5%;top:30%;animation: float6 18s ease-in-out infinite alternate, pulse6 11s ease-in-out infinite}
.o7{width:25vmax;height:25vmax;background:radial-gradient(closest-side, var(--a4), transparent 70%);right:-10%;top:20%;animation: float7 25s ease-in-out infinite alternate, pulse7 8s ease-in-out infinite}
@keyframes float1{to{transform:translate3d(4vmax,3vmax,0)}}
@keyframes float2{to{transform:translate3d(-3vmax,-4vmax,0)}}
@keyframes float3{to{transform:translate(-55%,-45%)}}
@keyframes float4{to{transform:translate3d(6vmax,-2vmax,0)}}
@keyframes float5{to{transform:translate3d(-5vmax,4vmax,0)}}
@keyframes float6{to{transform:translate3d(8vmax,-3vmax,0)}}
@keyframes float7{to{transform:translate3d(-4vmax,6vmax,0)}}
@keyframes pulse1{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
@keyframes pulse2{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}
@keyframes pulse3{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
@keyframes pulse4{0%,100%{transform:scale(1)}50%{transform:scale(1.25)}}
@keyframes pulse5{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
@keyframes pulse6{0%,100%{transform:scale(1)}50%{transform:scale(1.4)}}
@keyframes pulse7{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}

/* terminal */
.terminal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);max-width:960px;width:92vw;z-index:10;border:1px solid var(--edge);border-radius:18px;backdrop-filter:saturate(140%) blur(8px);background:var(--glass);box-shadow:0 20px 60px rgba(0,0,0,0.45)}
.term-top{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(73,72,62,0.6)}
.dot{width:10px;height:10px;border-radius:50%;position:relative}
.dot.r{background:#ff5f56}
.dot.y{background:#ffbd2e}
.dot.g{background:#27c93f}
.term-top .title{margin-left:6px;font-size:13px;color:var(--muted)}
.screen{height:min(58vh,520px);padding:14px 16px 8px 16px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:14px;position:relative}
.screen::-webkit-scrollbar{height:8px;width:8px}
.screen::-webkit-scrollbar-thumb{background:rgba(230,219,116,0.25);border-radius:8px}
.line{white-space:pre-wrap;word-break:break-word}
.muted{color:var(--muted)}
.ok{color:#a6e22e}
.warn{color:#fd971f}
.err{color:#f92672}
.link{color:#66d9ef;text-decoration:underline}
.cmd-link{color:#ae81ff;text-decoration:underline;cursor:pointer}
.screen [contenteditable]{outline:0;border:0;box-shadow:none;-webkit-tap-highlight-color:transparent}
.screen [contenteditable]:focus{outline:0;border:0;box-shadow:none}
.screen [contenteditable]:focus-visible{outline:0}
.input-line{display:flex;align-items:center;gap:8px;padding:10px 14px;border-top:1px solid rgba(113,195,255,0.18);font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
.prompt{color:#9fb0d4}
#cmd{flex:1;background:transparent;border:0;outline:none;color:var(--ink);font:inherit}
.user{color:#6ae2ff}
.host{color:#a86bff}
.path{color:#00e4a8}
.caret{display:inline-block;width:8px;height:1.2em;background:rgba(248,248,242,0.7);vertical-align:text-bottom;animation:blink 1s steps(1) infinite}
@keyframes blink{50%{opacity:0}}
@media (max-width:640px){ .terminal{left:50%;top:50%;transform:translate(-50%,-50%);width:93vw} .screen{height:56vh} }
@media (max-height:680px){ .screen{height:52vh} }
/* sl train */
.sl-train{position:absolute;left:0;bottom:8px;white-space:pre;pointer-events:none;user-select:none;color:#eaf0ff;text-shadow:0 2px 6px rgba(0,0,0,0.6);will-change:transform}
.sl-smoke{position:absolute;left:0;bottom:8px;pointer-events:none;user-select:none;color:#eaf0ff;opacity:0.85;will-change:transform}
.hidden{display:none}
.exit-gif{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);max-width:820px;width:80vw;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,0.45);opacity:0;transition:opacity .6s ease;object-fit:contain}
.term-top .dot{cursor:default}
.term-top .dot.r{cursor:pointer}
.term-top .dot.r::before,.term-top .dot.r::after{content:"";position:absolute;left:50%;top:50%;width:8px;height:2px;background:rgba(0,0,0,0.55);border-radius:2px;transform-origin:center;transform:translate(-50%,-50%) rotate(45deg);opacity:0;transition:opacity .15s ease}
.term-top .dot.r::after{transform:translate(-50%,-50%) rotate(-45deg)}
.term-top .dot.r:hover::before,.term-top .dot.r:hover::after{opacity:1}
</style>
</head>
<body>
<div class="stage" id="stage">
<div class="noise"></div>
<div class="orb o1"></div>
<div class="orb o2"></div>
<div class="orb o3"></div>
<div class="orb o4"></div>
<div class="orb o5"></div>
<div class="orb o6"></div>
<div class="orb o7"></div>
</div>

<div class="terminal" id="terminal">
<div class="term-top"><span class="dot r" id="term-close" role="button" tabindex="0" aria-label="Close"></span><span class="dot y"></span><span class="dot g"></span><span class="title">zsh — sleep3r</span></div>
<div class="screen" id="screen" aria-live="polite"></div>
</div>
<video src="fbt-renvor.mp4" id="exitVideo" class="exit-gif hidden" playsinline muted></video>

<script>
(function(){
const qs = new URLSearchParams(location.search);
const storeKey = "sleep3r_card_cfg_v1";
const cfg = (()=>{ try{ return JSON.parse(localStorage.getItem(storeKey))||{} }catch(_){ return {} }})();
function pick(name, def){ return qs.get(name) || cfg[name] || def }
const socials = {
  tg: pick("tg", "sleep3r"),
  gh: pick("gh", "sleep3r"),
  li: pick("li", "in/aukalashnikov")
};
const provided = ["tg","gh","li"].reduce((a,k)=>{ if(qs.get(k)) a[k]=qs.get(k); return a },{});
if(Object.keys(provided).length){ localStorage.setItem(storeKey, JSON.stringify({...cfg, ...provided})) }

const screen = document.getElementById('screen');
const terminal = document.getElementById('terminal');
let inputEl = null; // contenteditable span for current input
const closeBtn = document.getElementById('term-close');
const exitVideo = document.getElementById('exitVideo');

const username = 'sleep3r';
const hostname = 'zsh';
const cwd = '~';

const commands = {};
const history = [];
let historyIndex = -1;
let slRunning = false;
let inputLocked = false;

function promptHtml(){
  return `<span class="user">${username}</span>@<span class="host">${hostname}</span> <span class="path">${cwd}</span> %`;
}
function scrollToBottom(){ screen.scrollTop = screen.scrollHeight }
function line(html, cls){ const div=document.createElement('div'); div.className = 'line' + (cls? ' '+cls:''); div.innerHTML = html; screen.appendChild(div); scrollToBottom(); }
function text(t, cls){ line(escapeHtml(t), cls) }
function escapeHtml(s){ return s.replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])) }
function link(href, label){ return `<a class="link" href="${href}" target="_blank" rel="noopener">${label||href}</a>` }
function cmdLink(cmd, label){ return `<span class="cmd-link" data-cmd="${escapeHtml(cmd)}">${label||escapeHtml(cmd)}</span>` }
function openUrl(u){ try{ window.open(u, '_blank', 'noopener'); }catch(_){} }

function placeCaretAtEnd(el){
  try{
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }catch(_){ }
}

function focusInput(){ if(inputEl && !inputLocked){ inputEl.focus(); placeCaretAtEnd(inputEl) } }

function createInputLine(initial){
  if(inputLocked) return;
  const row = document.createElement('div');
  row.className = 'line';
  row.innerHTML = `<span class="muted">${promptHtml()}</span> <span id="typed" contenteditable="true" autocapitalize="none" autocomplete="off" spellcheck="false"></span>`;
  screen.appendChild(row);
  inputEl = row.querySelector('#typed');
  if(typeof initial === 'string'){ inputEl.textContent = initial }
  focusInput();
  scrollToBottom();
}

function banner(){
  line(`<span class="ok">Welcome to</span> <b>sleep3r</b> <span class="muted">interactive zsh</span>`);
  line(`Type ${cmdLink('help')} to discover commands. Click suggestions to autofill.`,'muted');
}

function cmd_help(){
  line(`<b>Available</b>:`);
  const items = [
    ['help', 'show this help'],
    ['links', 'list social links'],
    ['open &lt;tg|gh|li|climbing&gt;', 'open link in a new tab'],
    ['tg | gh | li', 'shortcut to open socials'],
    ['baneks', 'open random joke (category b)'],
    ['projects', 'list projects'],
    ['sl', 'steam locomotive easter egg'],
    ['ls', 'list entries'],
    ['echo &lt;text&gt;', 'print text'],
    ['date', 'show date'],
    ['uname -a', 'system info'],
    ['whoami', 'current user'],
    ['clear', 'clear screen']
  ];
  items.forEach(([c,d])=> line(`  ${cmdLink(c)}  <span class="muted">${d}</span>`));
}

function cmd_links(){
  line(`<b>Links</b>:`);
  line(`  Telegram: ${link(`https://t.me/${socials.tg}`, '@'+socials.tg)}`);
  line(`  GitHub:   ${link(`https://github.com/${socials.gh}`, socials.gh)}`);
  line(`  LinkedIn: ${link(`https://www.linkedin.com/${socials.li}`, socials.li)}`);
}

function cmd_projects(){
  line(`<b>Projects</b>:`);
  line(`  ${cmdLink('open climbing', 'climbing.html')} — ${link('climbing.html','page')}`);
}

function cmd_ls(){
  line(`projects  links  readme`, 'muted');
}

function cmd_clear(){ screen.innerHTML=''; }

function cmd_echo(args){ text(args.join(' ')) }

function cmd_date(){ text(new Date().toLocaleString('ru-RU', {weekday:'short', year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'})) }

function cmd_uname(args){ text(`Darwin ${navigator.platform||'arm64'} 24.6.0 ${args.includes('-a')? '# zsh' : ''}`.trim()) }

function cmd_whoami(){ text(username) }

function cmd_open(args){
  const what = (args[0]||'').toLowerCase();
  if(!what){ line(`<span class="err">Usage:</span> ${cmdLink('open tg')}</span>`); return }
  const map = {
    tg: `https://t.me/${socials.tg}`,
    gh: `https://github.com/${socials.gh}`,
    li: `https://www.linkedin.com/${socials.li}`,
    climbing: `climbing.html`
  };
  const url = map[what] || (what.startsWith('http')? what : null);
  if(url){ line(`Opening ${link(url)}`); openUrl(url) } else { line(`<span class="err">Unknown target:</span> ${escapeHtml(what)}`) }
}

function cmd_baneks(){
  const src = 'https://baneks.site/random';
  const proxied = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(src + (src.includes('?')?'&':'?') + '_ts=' + Date.now());
  line('Fetching baneks…','muted');
  return fetch(proxied, { mode: 'cors', cache: 'no-store' })
    .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.text() })
    .then(html => {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const art = doc.querySelector('article');
      if(!art) throw new Error('article not found');
      const content = (art.textContent||'').replace(/\n\s+/g,'\n').trim();
      if(!content) throw new Error('empty article');
      // label removed per request
      content.split(/\n{2,}/).forEach(chunk => text(chunk.trim()));
    })
    .catch(err => {
      line(`<span class="warn">Failed to parse:</span> ${escapeHtml(String(err))}`);
      line(`Opening ${link(src, 'baneks: random b')}`);
      openUrl(src);
    });
}

function cmd_sl(){
  if(slRunning) return;
  slRunning = true;
  inputLocked = true;
  // ASCII locomotive frames
  const frames = [
String.raw`      ====        ________                _____
  _D _|  |_______/        \__I_I_____===__|____|____\__________________________
   |(_)---  |   H\________/ |   |        =|___ ___|      _________________
   /     |  |   H  |  |     |   |         ||_| |_||     _|                \
  |      |  |   H  |__--------------------| [___] |   =|  steam locomotive |
  | ________|___H__/__|_____/[][]~\_______|       |    |__________________|
  |/ |   |-----------I_____I [][] []  D   |=======|____|__________________|
__/ =| o |=-O=====O=====O=====O \ ____Y___________|__|____________________|__
 |/-=|___|=  O=====O=====O=====O   \_/ |   /                   /           \\
  \_/      \__/  \__/  \__/  \__/       |  /___________________/_____________\
`,
String.raw`      ====        ________                _____
  _D _|  |_______/        \__I_I_____===__|____|____\__________________________
   |(_)---  |   H\________/ |   |        =|___ ___|      _________________
   /     |  |   H  |  |     |   |         ||_| |_||     _|                \
  |      |  |   H  |__--------------------| [___] |   =|  steam locomotive |
  | ________|___H__/__|_____/[][]~\_______|       |    |__________________|
  |/ |   |-----------I_____I [][] []  D   |=======|____|__________________|
__/ =| o |=-O=====O=====O=====O \ ____Y___________|__|____________________|__
 |/-=|___|=  O=====O=====O=====O   \_/ |   /                 /             \\
  \_/      \__/  \__/  \__/  \__/       |  /_________________/_______________\
`];

  // store current screen and disable input
  const previousHTML = screen.innerHTML;
  screen.innerHTML = '';

  const train = document.createElement('pre');
  train.className = 'sl-train';
  train.textContent = frames[0];
  screen.appendChild(train);
  const vw = screen.clientWidth;
  const trainWidth = train.getBoundingClientRect().width || 600;
  const xStart = vw + 40;
  const xEnd = -trainWidth - 60;
  const distance = xStart - xEnd;
  const duration = Math.max(3500, Math.min(9000, (distance / 160) * 1000));
  const start = performance.now();
  let frame = 0;
  let lastFrame = start;
  let lastSmoke = start;
  const smokes = [];

  function easeInOutCubic(p){ return p < 0.5 ? 4*p*p*p : 1 - Math.pow(-2*p + 2, 3)/2 }

  function spawnSmoke(now, x){
    const el = document.createElement('div');
    el.className = 'sl-smoke';
    el.textContent = '●';
    screen.appendChild(el);
    const obj = {
      el,
      born: now,
      x0: x + trainWidth * 0.18,
      y: 0,
      vx: 20 + Math.random()*30,
      vy: 28 + Math.random()*22,
      life: 1400 + Math.random()*700,
      scale: 0.7 + Math.random()*0.6
    };
    smokes.push(obj);
  }

  function step(now){
    const p = Math.min(1, (now - start) / duration);
    const eased = easeInOutCubic(p);
    const x = xStart + (xEnd - xStart) * eased;
    const y = Math.sin(now * 0.012) * 2.2; // gentle bobbing

    if(now - lastFrame > 120){ frame = (frame + 1) % frames.length; lastFrame = now; }
    train.textContent = frames[frame];
    train.style.transform = `translate(${x}px, ${y}px)`;

    if(now - lastSmoke > 140){ lastSmoke = now; spawnSmoke(now, x) }
    // update smoke
    for(let i=smokes.length-1;i>=0;i--){
      const s = smokes[i];
      const age = now - s.born;
      const k = age / s.life;
      if(k >= 1){ s.el.remove(); smokes.splice(i,1); continue }
      const dx = s.vx * k * 0.9;
      const dy = s.vy * k;
      const fade = 1 - k;
      const scale = s.scale * (0.6 + 0.8*k);
      s.el.style.transform = `translate(${s.x0 + dx}px, ${-dy}px) scale(${scale})`;
      s.el.style.opacity = String(0.85 * fade);
    }

    if(p < 1){ requestAnimationFrame(step) } else {
      // finish: restore
      screen.innerHTML = previousHTML;
      inputLocked = false;
      createInputLine('');
      slRunning = false;
    }
  }
  requestAnimationFrame(step);
}

// registry
Object.assign(commands, {
  help: cmd_help,
  links: cmd_links,
  projects: cmd_projects,
  ls: cmd_ls,
  clear: cmd_clear,
  echo: cmd_echo,
  date: cmd_date,
  uname: cmd_uname,
  whoami: cmd_whoami,
  open: cmd_open,
  baneks: cmd_baneks,
  sl: cmd_sl,
  tg: ()=>cmd_open(['tg']),
  gh: ()=>cmd_open(['gh']),
  li: ()=>cmd_open(['li'])
});

function run(raw){
  const inputText = raw.trim();
  if(!inputText) return;
  const parts = inputText.split(/\s+/);
  const cmd = parts.shift().toLowerCase();
  history.push(raw); historyIndex = history.length;
  const fn = commands[cmd];
  if(fn){ try{ return fn(parts) } catch(err){ line(`<span class=\"err\">Error:</span> ${escapeHtml(String(err))}`) } }
  else { line(`<span class="err">Command not found:</span> ${escapeHtml(cmd)}. Try ${cmdLink('help')}`) }
}

// events
document.addEventListener('click', (e)=>{
  const target = e.target;
  if(target && target.dataset && target.dataset.cmd){
    if(inputEl){ inputEl.textContent = target.dataset.cmd; }
    focusInput();
  } else {
    focusInput();
  }
});

document.addEventListener('keydown', (e)=>{
  if(!inputEl || inputLocked) return;
  if(e.key === 'Enter'){
    const v = inputEl.textContent || '';
    inputEl.removeAttribute('contenteditable');
    inputLocked = true;
    const done = ()=>{ if(!slRunning){ inputLocked = false; createInputLine(''); } };
    const res = run(v);
    if(res && typeof res.then === 'function'){
      res.then(done).catch(err=>{ line(`<span class=\"err\">Error:</span> ${escapeHtml(String(err))}`); done(); });
    } else {
      done();
    }
    e.preventDefault(); return;
  }
  if(e.key === 'ArrowUp'){
    if(history.length){ historyIndex = Math.max(0, historyIndex-1); if(inputEl){ inputEl.textContent = history[historyIndex]||''; placeCaretAtEnd(inputEl); } }
    e.preventDefault(); return;
  }
  if(e.key === 'ArrowDown'){
    if(history.length){ historyIndex = Math.min(history.length, historyIndex+1); if(inputEl){ inputEl.textContent = history[historyIndex]||''; placeCaretAtEnd(inputEl); } }
    e.preventDefault(); return;
  }
  if(e.key === 'Tab'){
    const v = (inputEl.textContent||'').trim();
    const all = Object.keys(commands);
    const match = all.filter(c=> c.startsWith(v))[0];
    if(match && inputEl){ inputEl.textContent = match + ' '; placeCaretAtEnd(inputEl); }
    e.preventDefault(); return;
  }
});

function init(){
  banner();
  cmd_links();
  line('');
  line(`Try ${cmdLink('projects')}, ${cmdLink('links')}, ${cmdLink('help')}`,'muted');
  createInputLine('');
}

init();
// close actions
function performExit(){
  try{ inputLocked = true }catch(_){}
  terminal.classList.add('hidden');

  exitVideo.classList.remove('hidden');
  requestAnimationFrame(() => {
    exitVideo.style.opacity = '1';
  });

  exitVideo.currentTime = 0;
  exitVideo.play().catch(err => console.error("Video play failed:", err));

  const FADE_MS = 600;

  const onVideoReady = () => {
    const durationMs = exitVideo.duration * 1000;
    const effectiveDuration = (durationMs && isFinite(durationMs)) ? durationMs : 2800;

    const fadeOutTime = Math.max(0, effectiveDuration - FADE_MS);

    setTimeout(() => {
      exitVideo.style.opacity = '0';
    }, fadeOutTime);
  };

  if (exitVideo.readyState >= 1) { // HAVE_METADATA
    onVideoReady();
  } else {
    exitVideo.addEventListener('loadedmetadata', onVideoReady, { once: true });
  }

  exitVideo.onended = () => {
    setTimeout(() => {
      exitVideo.classList.add('hidden');
      exitVideo.style.opacity = ''; // Reset for next time
    }, FADE_MS);
  };
}
closeBtn.addEventListener('click', performExit);
closeBtn.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); performExit(); } });
})();
</script>
</body>
</html>